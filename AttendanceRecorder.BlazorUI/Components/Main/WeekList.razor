<h2>Weeks</h2>

@if (_weeks == null)
{
    <p>Loading weeks...</p>
}
else
{
    <ul class="list-unstyled selection-list">
        @foreach (var week in _weeks)
        {
            <li>
                <button type="button"
                        class="btn selection-list-btn @(week == _selectedWeek ? "btn-primary" : "btn-secondary")"
                        @onclick="() => SelectWeek(week)"
                        aria-pressed="@(week == _selectedWeek)"
                        aria-label="Select week @week">
                    Week @week
                </button>
            </li>
        }
    </ul>
}

@code {
    [Parameter] public int? Year { get; set; }
    [Parameter] public EventCallback<int> SelectedWeekChanged { get; set; }

    private IEnumerable<int>? _weeks;
    private int? _selectedWeek;
    private int? _loadedYear;

    protected override async Task OnParametersSetAsync()
    {
        if (Year == null)
        {
            _weeks = null;
            _selectedWeek = null;
            _loadedYear = null;
            return;
        }

        if (_loadedYear != Year)
        {
            var apiClient = new ApiClient("http://localhost:5225", new HttpClient());
            _weeks = (await apiClient.Weeks2Async(Year.Value)).OrderByDescending(w => w);
            _selectedWeek = _weeks.FirstOrDefault();
            _loadedYear = Year;
            if (_selectedWeek.HasValue)
            {
                await SelectedWeekChanged.InvokeAsync(_selectedWeek.Value); // initial notify
            }
        }
    }

    private async Task SelectWeek(int week)
    {
        if (_selectedWeek == week)
        {
            return;
        }

        _selectedWeek = week;
        await SelectedWeekChanged.InvokeAsync(week);
    }

}